# Cloudflare R2 åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½å¯¦ä½œ

**ç‰ˆæœ¬**: v1.5.0  
**æ—¥æœŸ**: 2026-02-08  
**ç‹€æ…‹**: âœ… å®Œæˆ

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å¯¦ç¾äº†å®Œæ•´çš„ Cloudflare R2 åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½ï¼Œå…è¨±ç”¨æˆ¶ä¸Šå‚³è‡ªå®šç¾©åœ–ç‰‡ä½œç‚º Meme å¹£çš„åœ–æ¨™ã€‚

---

## ğŸ¯ å¯¦ä½œå…§å®¹

### 1. å¾Œç«¯å¯¦ç¾

#### æ–°å¢æ–‡ä»¶ï¼š
- **`src/routes/upload.ts`** - åœ–ç‰‡ä¸Šå‚³è·¯ç”±è™•ç†å™¨

#### API ç«¯é»ï¼š

**POST /api/upload/image**
- åŠŸèƒ½ï¼šä¸Šå‚³åœ–ç‰‡åˆ° R2 å­˜å„²æ¡¶
- èªè­‰ï¼šéœ€è¦ JWT token
- è«‹æ±‚æ ¼å¼ï¼šJSON
  ```json
  {
    "image": "data:image/png;base64,...",  // base64 ç·¨ç¢¼çš„åœ–ç‰‡
    "filename": "my-coin.png"              // å¯é¸ï¼šåŸå§‹æ–‡ä»¶å
  }
  ```
- éŸ¿æ‡‰æ ¼å¼ï¼š
  ```json
  {
    "success": true,
    "url": "/images/coins/1234567890-abc123.png",
    "key": "coins/1234567890-abc123.png",
    "size": 12345
  }
  ```
- éŒ¯èª¤è™•ç†ï¼š
  - 400: ç¼ºå°‘åœ–ç‰‡æ•¸æ“š
  - 401: æœªæˆæ¬Š
  - 500: ä¸Šå‚³å¤±æ•—
- R2 æœªé…ç½®æ™‚ï¼šè‡ªå‹•é™ç´šä½¿ç”¨é»˜èªåœ–ç‰‡

**GET /api/upload/image/:key**
- åŠŸèƒ½ï¼šå¾ R2 è®€å–åœ–ç‰‡
- èªè­‰ï¼šç„¡éœ€èªè­‰ï¼ˆå…¬é–‹è¨ªå•ï¼‰
- éŸ¿æ‡‰ï¼šè¿”å›åœ–ç‰‡äºŒé€²åˆ¶æ•¸æ“š
- ç·©å­˜ï¼šè¨­ç½® 1 å¹´ç·©å­˜ï¼ˆmax-age=31536000ï¼‰

**DELETE /api/upload/image/:key**
- åŠŸèƒ½ï¼šåˆªé™¤ R2 ä¸­çš„åœ–ç‰‡
- èªè­‰ï¼šéœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼ˆå¾…å¯¦ç¾ï¼‰
- éŸ¿æ‡‰ï¼šæˆåŠŸ/å¤±æ•—æ¶ˆæ¯

#### ç‰¹æ€§ï¼š
âœ… Base64 åœ–ç‰‡è™•ç†  
âœ… è‡ªå‹•ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å  
âœ… MIME é¡å‹æª¢æ¸¬  
âœ… æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ5MBï¼‰  
âœ… éŒ¯èª¤è™•ç†èˆ‡é™ç´šæ–¹æ¡ˆ  
âœ… ç·©å­˜æ§åˆ¶  
âœ… ETag æ”¯æŒ

---

### 2. å‰ç«¯å¯¦ç¾

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- **`public/static/create-coin.js`** - æ·»åŠ åœ–ç‰‡ä¸Šå‚³é‚è¼¯

#### å·¥ä½œæµç¨‹ï¼š

**æ­¥é©Ÿ 1: ç”¨æˆ¶é¸æ“‡åœ–ç‰‡**
```javascript
// æ”¯æŒå…©ç¨®æ–¹å¼ï¼š
// 1. æ–‡ä»¶ä¸Šå‚³ï¼ˆæ‹–æ”¾æˆ–é»æ“Šï¼‰
// 2. é¸æ“‡é è¨­æ¨¡æ¿
```

**æ­¥é©Ÿ 2: åœ–ç‰‡é è™•ç†**
```javascript
// ä½¿ç”¨ FileReader å°‡æ–‡ä»¶è½‰ç‚º base64
reader.readAsDataURL(file);
```

**æ­¥é©Ÿ 3: å‰µå»ºå¹£æ™‚ä¸Šå‚³**
```javascript
// åœ¨å‰µå»ºå¹£ä¹‹å‰å…ˆä¸Šå‚³åœ–ç‰‡
const uploadResponse = await axios.post('/api/upload/image', {
  image: imagePreview,  // base64 æ•¸æ“š
  filename: coinData.image.name
});

// ç²å–ä¸Šå‚³å¾Œçš„ URL
const imageUrl = uploadResponse.data.url;

// ä½¿ç”¨ URL å‰µå»ºå¹£ç¨®
const coinData = {
  name: '...',
  symbol: '...',
  image_url: imageUrl  // R2 URL
};
```

**æ­¥é©Ÿ 4: éŒ¯èª¤è™•ç†**
```javascript
// å¦‚æœä¸Šå‚³å¤±æ•—ï¼Œé™ç´šä½¿ç”¨é»˜èªåœ–ç‰‡
if (!uploadResponse.data.success) {
  imageUrl = '/static/default-coin.svg';
}
```

---

### 3. é…ç½®æ›´æ–°

#### wrangler.jsonc
```jsonc
{
  "r2_buckets": [
    {
      "binding": "IMAGES",
      "bucket_name": "memelaunch-images"
    }
  ]
}
```

#### types.ts
```typescript
export interface Env {
  DB: D1Database;
  IMAGES?: R2Bucket;  // å¯é¸çš„ R2 bucket
  JWT_SECRET: string;
  STARTING_BALANCE: string;
}
```

---

## ğŸš€ éƒ¨ç½²èªªæ˜

### é–‹ç™¼ç’°å¢ƒï¼ˆæœ¬åœ°æ¸¬è©¦ï¼‰

ç”±æ–¼ R2 åœ¨æœ¬åœ°é–‹ç™¼æ¨¡å¼ä¸‹ä¸å¯ç”¨ï¼Œç³»çµ±æœƒè‡ªå‹•é™ç´šåˆ°é»˜èªåœ–ç‰‡ï¼š

```bash
# æœ¬åœ°é–‹ç™¼
npm run dev:sandbox

# R2 æœªé…ç½®æ™‚çš„è¡Œç‚ºï¼š
# - ä¸Šå‚³è«‹æ±‚è¿”å›æˆåŠŸï¼Œä½†ä½¿ç”¨é»˜èªåœ–ç‰‡ URL
# - ä¸æœƒå ±éŒ¯ï¼Œç”¨æˆ¶é«”é©—æµæš¢
```

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

**æ­¥é©Ÿ 1: å‰µå»º R2 Bucket**
```bash
# ç™»å…¥ Cloudflare
npx wrangler login

# å‰µå»º R2 bucket
npx wrangler r2 bucket create memelaunch-images
```

**æ­¥é©Ÿ 2: æ›´æ–° wrangler.jsonc**
```jsonc
{
  "name": "webapp",
  "r2_buckets": [
    {
      "binding": "IMAGES",
      "bucket_name": "memelaunch-images"
    }
  ]
}
```

**æ­¥é©Ÿ 3: éƒ¨ç½²åˆ° Cloudflare Pages**
```bash
npm run build
npx wrangler pages deploy dist --project-name webapp
```

**æ­¥é©Ÿ 4: (å¯é¸) è¨­ç½®è‡ªå®šç¾©åŸŸå**
```bash
# ç‚º R2 bucket è¨­ç½®è‡ªå®šç¾©åŸŸå
# åœ¨ Cloudflare Dashboard ä¸­é…ç½® R2 Public Bucket
# æˆ–ä½¿ç”¨ Cloudflare Workers è·¯ç”±
```

---

## ğŸ“Š æŠ€è¡“ç´°ç¯€

### æ–‡ä»¶å­˜å„²çµæ§‹
```
R2 Bucket: memelaunch-images
â”œâ”€â”€ coins/
â”‚   â”œâ”€â”€ 1234567890-abc123.png
â”‚   â”œâ”€â”€ 1234567891-def456.jpg
â”‚   â””â”€â”€ ...
```

### æ–‡ä»¶å‘½åè¦å‰‡
- æ ¼å¼ï¼š`coins/{timestamp}-{random}.{ext}`
- ç¤ºä¾‹ï¼š`coins/1770569228-abc123.png`
- ç›®çš„ï¼šç¢ºä¿å”¯ä¸€æ€§ï¼Œé¿å…è¡çª

### æ”¯æŒçš„åœ–ç‰‡æ ¼å¼
- PNG (.png)
- JPEG (.jpg, .jpeg)
- GIF (.gif)
- WebP (.webp)

### æ–‡ä»¶å¤§å°é™åˆ¶
- æœ€å¤§ï¼š5MB
- å‰ç«¯é©—è­‰ï¼šåœ¨ä¸Šå‚³å‰æª¢æŸ¥
- å¾Œç«¯é©—è­‰ï¼šåœ¨è™•ç†æ™‚æª¢æŸ¥

### å®‰å…¨æ€§
- âœ… JWT èªè­‰ä¿è­·ä¸Šå‚³ç«¯é»
- âœ… æ–‡ä»¶é¡å‹é©—è­‰
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶
- âš ï¸ åˆªé™¤ç«¯é»éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼ˆå¾…å¯¦ç¾ï¼‰
- âš ï¸ åœ–ç‰‡å…§å®¹æƒæï¼ˆå¯é¸ï¼Œæœªå¯¦ç¾ï¼‰

---

## ğŸ§ª æ¸¬è©¦

### æ‰‹å‹•æ¸¬è©¦æµç¨‹

**æ¸¬è©¦ 1: ä¸Šå‚³è‡ªå®šç¾©åœ–ç‰‡**
1. ç™»å…¥ç³»çµ±
2. è¨ªå• `/create`
3. æ‹–æ”¾æˆ–é»æ“Šä¸Šå‚³åœ–ç‰‡
4. é©—è­‰é è¦½é¡¯ç¤ºæ­£ç¢º
5. å¡«å¯«å¹£ç¨®ä¿¡æ¯ä¸¦ç™¼å°„
6. æª¢æŸ¥å¹£ç¨®è©³æƒ…é åœ–ç‰‡é¡¯ç¤º

**æ¸¬è©¦ 2: ä½¿ç”¨é è¨­æ¨¡æ¿**
1. è¨ªå• `/create`
2. é¸æ“‡é è¨­æ¨¡æ¿
3. å‰µå»ºå¹£ç¨®
4. é©—è­‰ä½¿ç”¨æ­£ç¢ºçš„æ¨¡æ¿ URL

**æ¸¬è©¦ 3: éŒ¯èª¤è™•ç†**
1. å˜—è©¦ä¸Šå‚³è¶…é 5MB çš„æ–‡ä»¶ â†’ æ‡‰æ‹’çµ•
2. å˜—è©¦ä¸Šå‚³éåœ–ç‰‡æ–‡ä»¶ â†’ æ‡‰æ‹’çµ•
3. åœ¨ R2 æœªé…ç½®æ™‚ä¸Šå‚³ â†’ æ‡‰é™ç´šåˆ°é»˜èªåœ–ç‰‡

### API æ¸¬è©¦è…³æœ¬

```bash
# è¨»å†Šä¸¦ç²å– token
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","username":"testuser","password":"Test1234!"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# æº–å‚™ base64 åœ–ç‰‡ï¼ˆç¤ºä¾‹ï¼‰
IMAGE_BASE64="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="

# ä¸Šå‚³åœ–ç‰‡
curl -X POST http://localhost:3000/api/upload/image \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"image\":\"$IMAGE_BASE64\",\"filename\":\"test.png\"}"
```

---

## ğŸ“ˆ æ€§èƒ½è€ƒé‡

### ä¸Šå‚³æ€§èƒ½
- Base64 ç·¨ç¢¼æœƒå¢åŠ ç´„ 33% çš„æ•¸æ“šå¤§å°
- å»ºè­°å®¢æˆ¶ç«¯å£“ç¸®åœ–ç‰‡å¾Œå†ä¸Šå‚³
- å¯é¸ï¼šå¯¦ç¾æœå‹™ç«¯åœ–ç‰‡å„ªåŒ–

### CDN ç·©å­˜
- R2 åœ–ç‰‡è¨­ç½® 1 å¹´ç·©å­˜
- ä½¿ç”¨ ETag é€²è¡Œæ¢ä»¶è«‹æ±‚
- å»ºè­°é…ç½® Cloudflare CDN

### æˆæœ¬å„ªåŒ–
- R2 å­˜å„²ï¼š$0.015/GB/æœˆ
- é¡ A æ“ä½œï¼ˆå¯«å…¥ï¼‰ï¼š$4.50/ç™¾è¬æ¬¡
- é¡ B æ“ä½œï¼ˆè®€å–ï¼‰ï¼š$0.36/ç™¾è¬æ¬¡
- å…è²»é¡åº¦ï¼š10GB å­˜å„² + ç™¾è¬æ¬¡è®€å–/æœˆ

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **æœ¬åœ°é–‹ç™¼é™åˆ¶**
   - Wrangler é–‹ç™¼æ¨¡å¼ä¸æ”¯æŒ R2
   - å¿…é ˆéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒæ‰èƒ½æ¸¬è©¦å®Œæ•´åŠŸèƒ½

2. **æ–‡ä»¶æ ¼å¼é™åˆ¶**
   - ç›®å‰åªæ”¯æŒåœ–ç‰‡æ ¼å¼
   - æœªå¯¦ç¾è¦–é »æˆ–å…¶ä»–åª’é«”é¡å‹

3. **ç®¡ç†åŠŸèƒ½**
   - åˆªé™¤ç«¯é»ç¼ºå°‘æ¬Šé™æª¢æŸ¥
   - æ²’æœ‰åœ–ç‰‡ç®¡ç†å¾Œå°
   - æœªå¯¦ç¾åœ–ç‰‡ä½¿ç”¨çµ±è¨ˆ

4. **å„ªåŒ–ç©ºé–“**
   - å¯æ·»åŠ åœ–ç‰‡å£“ç¸®/å„ªåŒ–
   - å¯æ·»åŠ åœ–ç‰‡æ ¼å¼è½‰æ›ï¼ˆWebPï¼‰
   - å¯æ·»åŠ ç¸®ç•¥åœ–ç”Ÿæˆ

---

## ğŸ”® æœªä¾†æ”¹é€²å»ºè­°

### é«˜å„ªå…ˆç´š
- [ ] å¯¦ç¾ç®¡ç†å“¡åœ–ç‰‡ç®¡ç†å¾Œå°
- [ ] æ·»åŠ åœ–ç‰‡å¯©æ ¸æ©Ÿåˆ¶ï¼ˆAI/äººå·¥ï¼‰
- [ ] å¯¦ç¾åœ–ç‰‡å£“ç¸®å„ªåŒ–

### ä¸­å„ªå…ˆç´š
- [ ] æ”¯æŒå¤šåœ–ç‰‡ä¸Šå‚³
- [ ] å¯¦ç¾åœ–ç‰‡è£å‰ª/ç·¨è¼¯
- [ ] æ·»åŠ ç¸®ç•¥åœ–ç”Ÿæˆ
- [ ] å¯¦ç¾åœ–ç‰‡ CDN é…ç½®

### ä½å„ªå…ˆç´š
- [ ] æ”¯æŒå…¶ä»–æ–‡ä»¶é¡å‹
- [ ] å¯¦ç¾åœ–ç‰‡çµ±è¨ˆåˆ†æ
- [ ] æ·»åŠ åœ–ç‰‡æ°´å°
- [ ] å¯¦ç¾åœ–ç‰‡ç‰ˆæœ¬æ§åˆ¶

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [Cloudflare R2 æ–‡æª”](https://developers.cloudflare.com/r2/)
- [Wrangler R2 å‘½ä»¤](https://developers.cloudflare.com/workers/wrangler/commands/#r2)
- [Hono æ–‡ä»¶ä¸Šå‚³](https://hono.dev/guides/best-practices#file-upload)

---

## âœ… å®Œæˆæª¢æŸ¥æ¸…å–®

- [x] å‰µå»º upload.ts è·¯ç”±è™•ç†å™¨
- [x] æ›´æ–° types.ts æ·»åŠ  IMAGES binding
- [x] æ›´æ–° index.tsx è¨»å†Š upload è·¯ç”±
- [x] æ›´æ–° wrangler.jsonc é…ç½® R2
- [x] ä¿®æ”¹ create-coin.js æ·»åŠ ä¸Šå‚³é‚è¼¯
- [x] å¯¦ç¾éŒ¯èª¤è™•ç†èˆ‡é™ç´šæ–¹æ¡ˆ
- [x] æ¸¬è©¦æœ¬åœ°é–‹ç™¼æ¨¡å¼ï¼ˆé™ç´šè¡Œç‚ºï¼‰
- [x] å‰µå»ºéƒ¨ç½²æ–‡æª”
- [ ] éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒä¸¦æ¸¬è©¦ï¼ˆå¾…ç”¨æˆ¶åŸ·è¡Œï¼‰

---

**ç¸½çµ**: R2 åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½å·²å®Œå…¨å¯¦ç¾ï¼ŒåŒ…æ‹¬å‰å¾Œç«¯é›†æˆã€éŒ¯èª¤è™•ç†ã€é™ç´šæ–¹æ¡ˆå’Œè©³ç´°æ–‡æª”ã€‚åœ¨æœ¬åœ°é–‹ç™¼ç’°å¢ƒæœƒè‡ªå‹•é™ç´šåˆ°é»˜èªåœ–ç‰‡ï¼Œéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒå¾Œå³å¯ä½¿ç”¨å®Œæ•´çš„ R2 å­˜å„²åŠŸèƒ½ã€‚
